<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/CMMN/20151109/MODEL" 
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
             xmlns:flowable="http://flowable.org/cmmn" 
             xmlns:cmmndi="http://www.omg.org/spec/CMMN/20151109/CMMNDI" 
             xmlns:dc="http://www.omg.org/spec/CMMN/20151109/DC" 
             xmlns:di="http://www.omg.org/spec/CMMN/20151109/DI" 
             targetNamespace="http://flowable.org/cmmn">
  
  <case id="orderCase" name="Order Management Case" flowable:initiatorVariableName="initiator">
    <casePlanModel id="casePlanModel" name="Order Case Plan" flowable:formFieldValidation="true">
      
      <planItem id="planItemOrderProcess" name="Execute Order Process" definitionRef="orderProcessTask">
        <itemControl>
          <extensionElements>
            <flowable:parentCompletionCondition>true</flowable:parentCompletionCondition>
          </extensionElements>
        </itemControl>
      </planItem>

      <planItem id="planItemRefundTask" name="Manual Refund Process" definitionRef="refundUserTask">
        <entryCriterion id="entryManualRefund" sentryRef="sentryRefundTrigger" />
      </planItem>

      <sentry id="sentryRefundTrigger">
        <planItemOnPart id="onPartOrderCancelled" sourceRef="planItemOrderProcess">
          <standardEvent>occur</standardEvent>
        </planItemOnPart>
      </sentry>

      <processTask id="orderProcessTask" name="Main Order Process" processRef="orderProcess" flowable:fallbackToDefaultTenant="true">
        <extensionElements>
          <flowable:in source="total" target="total" />
          <flowable:in source="items" target="items" />
          <flowable:in source="params" target="params" />
        </extensionElements>
      </processTask>

      <humanTask id="refundUserTask" name="Manual Refund Handling" flowable:assignee="${initiator}" />
      
    </casePlanModel>
  </case>

  <cmmndi:CMMNDI>
    <cmmndi:CMMNDiagram id="CMMNDiagram_orderCase">
      <cmmndi:CMMNShape id="CMMNShape_casePlanModel" cmmnElementRef="casePlanModel">
        <dc:Bounds x="30" y="30" width="600" height="400" />
        <cmmndi:CMMNLabel />
      </cmmndi:CMMNShape>
      <cmmndi:CMMNShape id="CMMNShape_planItemOrderProcess" cmmnElementRef="planItemOrderProcess">
        <dc:Bounds x="100" y="100" width="150" height="80" />
        <cmmndi:CMMNLabel />
      </cmmndi:CMMNShape>
      <cmmndi:CMMNShape id="CMMNShape_planItemRefundTask" cmmnElementRef="planItemRefundTask">
        <dc:Bounds x="350" y="100" width="150" height="80" />
        <cmmndi:CMMNLabel />
      </cmmndi:CMMNShape>
      <cmmndi:CMMNShape id="CMMNShape_entryManualRefund" cmmnElementRef="entryManualRefund">
        <dc:Bounds x="341" y="130" width="18" height="20" />
        <cmmndi:CMMNLabel />
      </cmmndi:CMMNShape>
      <cmmndi:CMMNEdge id="CMMNEdge_connectorRefund" cmmnElementRef="planItemOrderProcess" targetCMMNElementRef="entryManualRefund">
        <di:waypoint x="250" y="140" />
        <di:waypoint x="341" y="140" />
        <cmmndi:CMMNLabel />
      </cmmndi:CMMNEdge>
    </cmmndi:CMMNDiagram>
  </cmmndi:CMMNDI>
</definitions>