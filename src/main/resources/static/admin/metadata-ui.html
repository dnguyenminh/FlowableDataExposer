<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metadata Field-Check (Admin)</title>
  <style>
    body{font-family:Inter,Segoe UI,Arial;margin:20px;color:#222}
    h1{font-size:20px;margin-bottom:6px}
    .col{display:inline-block;vertical-align:top;width:48%;margin-right:2%}
    textarea{width:100%;height:200px;font-family:monospace;font-size:13px;padding:8px}
    button{margin:6px 4px;padding:8px 12px}
    pre{background:#f6f8fa;padding:12px;border-radius:6px;overflow:auto}
    .small{font-size:13px;color:#666}
    .result-ok{color:green}
    .result-err{color:#b02}
    label.block{display:block;margin-top:8px;font-weight:600}
  </style>
</head>
<body>
  <h1>Metadata Field‑Check — Admin (DEV)</h1>
  <p class="small">Trang nhỏ để BA/Dev thử mapping (JsonPath) trên một sample blob, xem kết quả trích xuất và áp metadata vào hệ thống.</p>

  <div class="col">
    <label class="block">Metadata (JSON)</label>
    <textarea id="metadata">{
  "class": "Order",
  "entityType": "Order",
  "mappings": [
    { "column": "total_amount", "jsonPath": "$.total", "exportToPlain": true, "plainColumn": "order_total" },
    { "column": "customer_id", "jsonPath": "$.customer.id", "exportToPlain": true, "plainColumn": "customer_id" },
    { "column": "customer_name", "jsonPath": "$.customer.name", "exportToPlain": true, "plainColumn": "customer_name" },
    { "column": "priority", "jsonPath": "$.meta.priority", "exportToPlain": true, "plainColumn": "order_priority" },
    { "column": "approval_status", "jsonPath": "$.approvalDecision.status", "exportToPlain": true, "plainColumn": "approval_status" },
    { "column": "decision_reason", "jsonPath": "$.approvalDecision.reason", "exportToPlain": true, "plainColumn": "decision_reason" },
    { "column": "item_1_id", "jsonPath": "$.items[0].id" }
  ]
}</textarea>

    <div style="margin-top:8px">
      <button id="btn-validate">Validate metadata</button>
      <button id="btn-apply">Apply (save to DB)</button>
      <span id="validate-status"></span>
    </div>

    <label class="block">Sample Blob (JSON)</label>
    <textarea id="sample">{
  "total": 123.45,
  "items": [{ "id": "item-xyz" }],
  "params": { "color": "red" }
}</textarea>

    <div style="margin-top:8px">
      <button id="btn-field-check">Field‑Check (preview extraction)</button>
      <span id="field-status"></span>
    </div>

    <label class="block">Field‑Check Result</label>
    <pre id="field-result">(no result)</pre>
  </div>

  <div class="col">
    <label class="block">Quick mapping editor</label>
    <div class="small">Edit mappings manually (one per line): <code>column|jsonPath|exportToPlain|plainColumn</code></div>
    <textarea id="mappings">total_amount|$.total|true|order_total
item_1_id|$.items[0].id|false|
</textarea>
    <div style="margin-top:8px">
      <button id="btn-sync-from-metadata">Sync → Mappings</button>
      <button id="btn-sync-to-metadata">Sync ← Mappings</button>
    </div>

    <label class="block">Preview generated plain payload (JSON)</label>
    <pre id="plain-preview">(no preview)</pre>

    <hr />
    <div class="small">Access this page at <code>/admin/metadata-ui.html</code>. This UI is for dev/BA only — protect behind auth in production.</div>
  </div>

<script>
const $ = id => document.getElementById(id);

function showStatus(id, ok, msg){
  const el = $(id);
  el.textContent = msg;
  el.className = ok ? 'result-ok' : 'result-err';
}

async function validateMetadata() {
  showStatus('validate-status', true, '...validating');
  try {
    const body = JSON.parse($('metadata').value);
    const res = await fetch('/api/metadata/validate', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const j = await res.json();
    if (res.ok && j.valid) showStatus('validate-status', true, 'OK');
    else showStatus('validate-status', false, JSON.stringify(j));
  } catch (err) {
    showStatus('validate-status', false, err.message);
  }
}

async function applyMetadata(){
  showStatus('validate-status', true, 'applying...');
  try {
    const body = JSON.parse($('metadata').value);
    const res = await fetch('/api/metadata/apply', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const j = await res.json();
    if (res.ok) showStatus('validate-status', true, 'imported: ' + (j.imported||'ok'));
    else showStatus('validate-status', false, JSON.stringify(j));
  } catch (err) { showStatus('validate-status', false, err.message); }
}

function mappingsFromText(txt){
  const lines = txt.split('\n').map(l=>l.trim()).filter(Boolean);
  return lines.map(l=>{
    const parts = l.split('|').map(p=>p.trim());
    return { column: parts[0], jsonPath: parts[1], exportToPlain: parts[2]==='true', plainColumn: parts[3]||null };
  });
}
function mappingsToText(mappings){
  return mappings.map(m=>`${m.column}|${m.jsonPath}|${m.exportToPlain||false}|${m.plainColumn||''}`).join('\n');
}

$('btn-validate').addEventListener('click', validateMetadata);
$('btn-apply').addEventListener('click', applyMetadata);

$('btn-field-check').addEventListener('click', async ()=>{
  showStatus('field-status', true, 'checking...');
  try {
    const payload = { class: JSON.parse($('metadata').value).class || 'Order', sampleBlob: JSON.parse($('sample').value) };
    const res = await fetch('/api/metadata/field-check', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const j = await res.json();
    if (res.ok) {
      $('field-result').textContent = JSON.stringify(j.extracted, null, 2);
      $('plain-preview').textContent = JSON.stringify(j.extracted, null, 2);
      showStatus('field-status', true, 'extracted ' + Object.keys(j.extracted).length + ' fields');
    } else {
      $('field-result').textContent = JSON.stringify(j, null, 2);
      showStatus('field-status', false, 'error');
    }
  } catch (err) { showStatus('field-status', false, err.message); }
});

$('btn-sync-from-metadata').addEventListener('click', ()=>{
  try{
    const md = JSON.parse($('metadata').value);
    const m = (md.mappings||[]).map(x=>({column:x.column,jsonPath:x.jsonPath,exportToPlain:!!x.exportToPlain,plainColumn:x.plainColumn||''}));
    $('mappings').value = mappingsToText(m);
  } catch(e){ alert(e.message); }
});
$('btn-sync-to-metadata').addEventListener('click', ()=>{
  try{
    const md = JSON.parse($('metadata').value);
    const m = mappingsFromText($('mappings').value);
    md.mappings = m;
    $('metadata').value = JSON.stringify(md, null, 2);
  } catch(e){ alert(e.message); }
});

// initialize
$('btn-sync-from-metadata').click();
</script>
</body>
</html>
